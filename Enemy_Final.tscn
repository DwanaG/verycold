[gd_scene load_steps=26 format=2]

[ext_resource path="res://Models/enemy.escn" type="PackedScene" id=1]
[ext_resource path="res://enemy_material.tres" type="Material" id=2]

[sub_resource type="GDScript" id=1]

script/source = "extends RigidBody

var state : String

export(float, 0, 100) var walk_speed
export(float, 0, 100) var run_speed
export(float, 0, 100) var accel

export(float, 0, 360) var fov
export(float, 0, 100) var view_range = 1000

export(float, 0, 10) var shoot_rate

export(bool) var debug

var close_plane = 0.5
var vertical_fov = 120

var states = [\"idle\", \"shooting\", \"moving_into_range\", \"chasing\"]

var isRunning : bool
var moveTarget : Transform
var head : Spatial
var headView : RayCast
var rotator : Spatial
var anim : AnimationTree

var frustum_planes = []

var playerCam;

var player_in_frustum = false
var player_raycast_success = false
var can_see_player = false
var geo
var path = []

var target_facing
var move_towards
var last_player_pos

func _ready():
	state = \"idle\"
	generate_frustum()
	
	var player = get_tree().root.find_node(\"Player\", true, false)
	if player:
		playerCam = player.find_node(\"Camera\")
	
	head = find_node(\"Head Position\")
	headView = find_node(\"Head View\")
	rotator = find_node(\"Rotation\")
	geo = get_tree().root.find_node(\"geo\", true, false)
	anim = find_node(\"AnimationTree\")
	
	anim.tree_root.set_start_node(\"Idle\")	
	
func world_frustum():
	var planes = []
	for plane in frustum_planes:
		var new_plane = []
		for vertex in plane:
			new_plane.append(head.to_global(vertex))
		planes.append(new_plane)
	return planes

func is_inside_frustum(point : Vector3):
	var frust = world_frustum()
	for plane in frust:
		var a : Vector3 = plane[1] - plane[0]
		var b : Vector3 = plane[2] - plane[1]
		var normal = a.cross(b).normalized()
		if normal.dot(point - plane[0]) > 0:
			return false
	return true
	
func _process(_delta):
	match state:
		\"idle\":
			process_idle()
		\"shooting\":
			process_shooting()
		\"moving_into_range\":
			process_moving_into_range()
		\"chasing\":
			process_chasing()
			
func _physics_process(delta):
	can_see_player = get_can_see_player()
	if path and path.size() > 0:
		move_along_path()
	if target_facing:
		rotate_towards_point(target_facing, 90, delta)
		
func get_can_see_player():
	if not playerCam: return false
	var playerPos = playerCam.global_transform.origin
	if is_inside_frustum(playerPos):
		var toPlayer = playerCam.global_transform.origin - headView.global_transform.origin
		var relativeToRotation = headView.global_transform.basis.inverse().xform(toPlayer)
		headView.cast_to = relativeToRotation
		if headView.is_colliding():
			var collider = headView.get_collider()
			if collider.get_filename() == \"res://Player.tscn\":
				return true
	return false
	
func process_idle():
	target_facing = null

	anim.set_dual(\"shooting\", false)
	anim.set_dual(\"moving\", false)

	if can_see_player:
		state = \"shooting\"
	
func process_shooting():
	anim.set_dual(\"shooting\", can_see_player)
	
	if not can_see_player:
		set_path_to_point(last_player_pos)
		state = \"chasing\"
		return
	
	target_facing = playerCam.global_transform.origin
	last_player_pos = playerCam.global_transform.origin
	
func process_moving_into_range():
	anim.set_dual(\"moving\", !can_see_player)
	
func process_chasing():
	isRunning = true
	anim.set_dual(\"moving\", !can_see_player)
	anim.set(\"parameters/Moving/WalkRun/blend_amount\", 1 if isRunning else 0)
	
	if can_see_player:
		state = \"shooting\"
		path = null
		return
	
	if not path or path.size() == 0:
		state = \"idle\"
		return
	
func set_path_to_point(point: Vector3):
	var nav : Navigation = get_tree().root.find_node(\"Navigation\", true, false)
	if not nav: return
	
	var targetNavPoint = nav.get_closest_point(point)
	var closestCurrentPoint = nav.get_closest_point(global_transform.origin)
	
	path = nav.get_simple_path(closestCurrentPoint, targetNavPoint)
	
func signed_angle(a, b, axis):
	a = a.normalized()
	b = b.normalized()
	return acos(a.dot(b)) * sign(axis.dot(a.cross(b)))
	
func rotate_towards_point(point : Vector3, degreesPerSecond: float, delta: float):
	var facing = rotator.global_transform.basis.z
	var flatVectorToTarget = Vector3(point.x - rotator.global_transform.origin.x, 0, point.z - rotator.global_transform.origin.z).normalized()
	var toTravel = signed_angle(facing, flatVectorToTarget, Vector3.UP)
	toTravel = min(abs(toTravel), deg2rad(degreesPerSecond) * delta) * sign(toTravel)
	var current = Quat(rotator.global_transform.basis)
	var new = Quat(Vector3.UP, toTravel)
	rotator.global_transform.basis = Basis(current * new)
	
func move_along_path():
	if not path or path.size() == 0: return
	
	var targetPathNode : Vector3 = path[0]
	
	var toPoint = global_transform.origin - targetPathNode
	
	if toPoint.length_squared() < 0.5: # Reached a nav point
		path.remove(0)
		if path.size() == 0:
			return # Arrived
			
		targetPathNode = path[0]
	
	target_facing = targetPathNode
	move_towards = targetPathNode
	
func _integrate_forces(state):
	if not move_towards: return
	
	var toPoint = move_towards - global_transform.origin
	var flatToPoint = Vector3(toPoint.x, 0, toPoint.z)
	
	state.add_central_force(flatToPoint.normalized() * accel)
	
	# Cap horizontal linear velocity
	var maxSpeed = run_speed if isRunning else walk_speed
	if Vector2(state.linear_velocity.x, state.linear_velocity.z).length_squared() > maxSpeed * maxSpeed:
		var new = Vector2(state.linear_velocity.x, state.linear_velocity.z).normalized() * maxSpeed
		state.linear_velocity = Vector3(new.x, state.linear_velocity.y, new.y)
	
func generate_frustum():
	var camUp = Vector3.UP
	var camRight = Vector3.RIGHT
	var nearCenter = Vector3.BACK * close_plane
	var farCenter = Vector3.BACK * view_range
	
	var nearHeight = 2 * tan(deg2rad(vertical_fov / 2.0)) * close_plane
	var farHeight = 2 * tan(deg2rad(vertical_fov / 2.0)) * view_range
	
	var nearWidth = 2 * tan(deg2rad(fov / 2.0)) * close_plane
	var farWidth = 2 * tan(deg2rad(fov / 2.0)) * view_range
	
	var farTopLeft = farCenter + camUp * (farHeight*0.5) - camRight * (farWidth*0.5);
	var farTopRight = farCenter + camUp * (farHeight*0.5) + camRight * (farWidth*0.5);
	var farBottomLeft = farCenter - camUp * (farHeight*0.5) - camRight * (farWidth*0.5);
	var farBottomRight = farCenter - camUp * (farHeight*0.5) + camRight * (farWidth*0.5);

	var nearTopLeft = nearCenter + camUp * (nearHeight*0.5) - camRight * (nearWidth*0.5);
	var nearTopRight = nearCenter + camUp * (nearHeight*0.5) + camRight * (nearWidth*0.5);
	var nearBottomLeft = nearCenter - camUp * (nearHeight*0.5) - camRight * (nearWidth*0.5);
	var nearBottomRight = nearCenter - camUp * (nearHeight*0.5) + camRight * (nearWidth*0.5);
	
	var left = [farTopLeft, nearTopLeft, nearBottomLeft, farBottomLeft]
	var right = [farTopRight, farBottomRight, nearBottomRight, nearTopRight]
	var top = [farTopLeft, farTopRight, nearTopRight, nearTopLeft]
	var bottom = [farBottomRight, farBottomLeft, nearBottomLeft, nearBottomRight]
	var front = [nearTopLeft, nearTopRight, nearBottomRight, nearBottomLeft]
	var back = [farTopRight, farTopLeft, farBottomLeft, farBottomRight]
	
	frustum_planes = [left, right, top, bottom, front, back]"

[sub_resource type="CapsuleShape" id=2]

radius = 0.383281
height = 2.58835

[sub_resource type="AnimationNodeAnimation" id=3]

filter_enabled = false
filters = [  ]
animation = "Idle"

[sub_resource type="AnimationNodeAnimation" id=4]

resource_local_to_scene = true
filter_enabled = false
filters = [  ]
animation = "Run"

[sub_resource type="AnimationNodeAnimation" id=5]

resource_local_to_scene = true
filter_enabled = false
filters = [  ]
animation = "PointGun"

[sub_resource type="AnimationNodeAnimation" id=6]

resource_local_to_scene = true
filter_enabled = false
filters = [  ]
animation = "Walk"

[sub_resource type="AnimationNodeBlend2" id=7]

resource_local_to_scene = true
filter_enabled = true
filters = [ "Skeleton:enemy_l_clavicle_jnt", "Skeleton:enemy_l_elbow_jnt", "Skeleton:enemy_l_finger0_01", "Skeleton:enemy_l_finger0_02", "Skeleton:enemy_l_finger0_03", "Skeleton:enemy_l_finger1_01", "Skeleton:enemy_l_finger1_02", "Skeleton:enemy_l_finger1_03", "Skeleton:enemy_l_finger2_01", "Skeleton:enemy_l_finger2_02", "Skeleton:enemy_l_shoulder_jnt", "Skeleton:enemy_l_wrist_jnt", "Skeleton:enemy_r_clavicle_jnt", "Skeleton:enemy_r_elbow_jnt", "Skeleton:enemy_r_finger0_01", "Skeleton:enemy_r_finger0_02", "Skeleton:enemy_r_finger0_03", "Skeleton:enemy_r_finger1_01", "Skeleton:enemy_r_finger1_02", "Skeleton:enemy_r_finger1_03", "Skeleton:enemy_r_finger2_01", "Skeleton:enemy_r_finger2_02", "Skeleton:enemy_r_shoulder_jnt", "Skeleton:enemy_r_wrist_jnt" ]
sync = true

[sub_resource type="AnimationNodeBlend2" id=8]

resource_local_to_scene = true
filter_enabled = false
filters = [  ]
sync = true

[sub_resource type="AnimationNodeBlendTree" id=9]

resource_local_to_scene = true
graph_offset = Vector2( -380, 34 )
nodes/Animation/node = SubResource( 6 )
nodes/Animation/position = Vector2( -200, 0 )
"nodes/Animation 2/node" = SubResource( 4 )
"nodes/Animation 2/position" = Vector2( -200, 180 )
"nodes/Animation 3/node" = SubResource( 5 )
"nodes/Animation 3/position" = Vector2( 120, 300 )
nodes/PointGun/node = SubResource( 7 )
nodes/PointGun/position = Vector2( 380, 140 )
nodes/WalkRun/node = SubResource( 8 )
nodes/WalkRun/position = Vector2( 160, 60 )
nodes/output/position = Vector2( 600, 100 )
node_connections = [ "output", 0, "PointGun", "PointGun", 0, "WalkRun", "PointGun", 1, "Animation 3", "WalkRun", 0, "Animation", "WalkRun", 1, "Animation 2" ]
_sections_unfolded = [ "Resource", "Script" ]

[sub_resource type="AnimationNodeAnimation" id=10]

filter_enabled = false
filters = [  ]
animation = "Fire"

[sub_resource type="AnimationNodeAnimation" id=11]

filter_enabled = false
filters = [  ]
animation = "PointGun"

[sub_resource type="AnimationNodeOneShot" id=12]

filter_enabled = false
filters = [  ]
fadein_time = 0.1
fadeout_time = 0.5
autorestart = false
autorestart_delay = 1.0
autorestart_random_delay = 0.0
sync = false

[sub_resource type="AnimationNodeTimeScale" id=13]


[sub_resource type="AnimationNodeBlendTree" id=14]

graph_offset = Vector2( -394, 64 )
nodes/Animation/node = SubResource( 11 )
nodes/Animation/position = Vector2( -20, 60 )
"nodes/Animation 2/node" = SubResource( 10 )
"nodes/Animation 2/position" = Vector2( -200, 220 )
nodes/OneShot/node = SubResource( 12 )
nodes/OneShot/position = Vector2( 280, 120 )
nodes/TimeScale/node = SubResource( 13 )
nodes/TimeScale/position = Vector2( 80, 200 )
nodes/output/position = Vector2( 560, 120 )
node_connections = [ "output", 0, "OneShot", "TimeScale", 0, "Animation 2", "OneShot", 0, "Animation", "OneShot", 1, "TimeScale" ]

[sub_resource type="AnimationNodeStateMachineTransition" id=15]

switch_mode = 0
auto_advance = false
advance_condition = "moving"
xfade_time = 0.5
priority = 1
disabled = false

[sub_resource type="AnimationNodeStateMachineTransition" id=16]

switch_mode = 0
auto_advance = false
advance_condition = "not_moving"
xfade_time = 0.2
priority = 1
disabled = false

[sub_resource type="AnimationNodeStateMachineTransition" id=17]

switch_mode = 0
auto_advance = false
advance_condition = "not_shooting"
xfade_time = 0.5
priority = 1
disabled = false

[sub_resource type="AnimationNodeStateMachineTransition" id=18]

switch_mode = 0
auto_advance = false
advance_condition = "shooting"
xfade_time = 0.2
priority = 1
disabled = false

[sub_resource type="AnimationNodeStateMachineTransition" id=19]

switch_mode = 0
auto_advance = false
advance_condition = "moving"
xfade_time = 0.5
priority = 1
disabled = false

[sub_resource type="AnimationNodeStateMachineTransition" id=20]

switch_mode = 0
auto_advance = false
advance_condition = "shooting"
xfade_time = 0.2
priority = 1
disabled = false

[sub_resource type="AnimationNodeStateMachine" id=21]

resource_local_to_scene = true
states/Idle/node = SubResource( 3 )
states/Idle/position = Vector2( 422, 157 )
states/Moving/node = SubResource( 9 )
states/Moving/position = Vector2( 184, 191 )
states/Shooting/node = SubResource( 14 )
states/Shooting/position = Vector2( 312, 326 )
transitions = [ "Idle", "Moving", SubResource( 15 ), "Moving", "Idle", SubResource( 16 ), "Shooting", "Idle", SubResource( 17 ), "Idle", "Shooting", SubResource( 18 ), "Shooting", "Moving", SubResource( 19 ), "Moving", "Shooting", SubResource( 20 ) ]
start_node = ""
end_node = ""
graph_offset = Vector2( -200, 115 )
_sections_unfolded = [ "Script" ]

[sub_resource type="AnimationNodeStateMachinePlayback" id=22]

resource_local_to_scene = true

[sub_resource type="GDScript" id=23]

script/source = "extends AnimationTree

var triggers = []
var triggers_del = []
	
func _process(_delta):
	# Triggers expire after one frame
	for trigger in triggers_del:
		set(trigger, false)
	triggers_del.clear()
	
	for trigger in triggers:
		triggers_del.append(trigger)
	triggers.clear()
	
func set_param(name: String, value: bool):
	set(\"parameters/conditions/\" + name, value)
	
func set_dual(name : String, value : bool):
	set_param(name, value)
	set_param(\"not_\" + name, !value)
	
func set_trigger(name):
	set_param(name, true)
	triggers.append(name)"

[node name="Enemy" type="RigidBody"]
input_ray_pickable = true
input_capture_on_drag = false
collision_layer = 1
collision_mask = 1
mode = 2
mass = 1.0
friction = 1.0
bounce = 0.0
physics_material_override = null
gravity_scale = 1.0
custom_integrator = false
continuous_cd = false
contacts_reported = 0
contact_monitor = false
sleeping = false
can_sleep = true
axis_lock_linear_x = false
axis_lock_linear_y = false
axis_lock_linear_z = false
axis_lock_angular_x = false
axis_lock_angular_y = false
axis_lock_angular_z = false
linear_velocity = Vector3( 0, 0, 0 )
linear_damp = -1.0
angular_velocity = Vector3( 0, 0, 0 )
angular_damp = -1.0
script = SubResource( 1 )
_sections_unfolded = [ "Transform" ]
walk_speed = 2.0
run_speed = 5.0
accel = 15.0
fov = 90.0
view_range = 50.0
shoot_rate = 3.0
debug = null

[node name="Main Collider" type="CollisionShape" parent="."]
transform = Transform( 1, 0, 0, 0, -4.37114e-08, 1, 0, -1, -4.37114e-08, 0, 1.66946, 0 )
shape = SubResource( 2 )
disabled = false

[node name="Rotation" type="Spatial" parent="."]
_sections_unfolded = [ "Transform" ]

[node name="Head Position" type="Position3D" parent="Rotation"]
transform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 2.96192, 0 )
_sections_unfolded = [ "Transform" ]

[node name="Head View" type="RayCast" parent="Rotation/Head Position"]
enabled = true
exclude_parent = true
cast_to = Vector3( 0, 0, 100 )
collision_mask = 1
collide_with_areas = false
collide_with_bodies = true
_sections_unfolded = [ "Collide With" ]

[node name="Model" parent="Rotation" instance=ExtResource( 1 )]

[node name="AnimationTree" type="AnimationTree" parent="Rotation/Model/Root_Motion" index="0"]
tree_root = SubResource( 21 )
anim_player = NodePath("../AnimationPlayer")
active = true
process_mode = 1
root_motion_track = NodePath("")
parameters/playback = SubResource( 22 )
parameters/conditions/moving = false
parameters/conditions/not_moving = false
parameters/conditions/not_shooting = false
parameters/conditions/shooting = false
parameters/Moving/PointGun/blend_amount = 0
parameters/Moving/WalkRun/blend_amount = 0
parameters/Shooting/OneShot/active = false
parameters/Shooting/TimeScale/scale = 1.5
script = SubResource( 23 )
_sections_unfolded = [ "Root Motion", "Script", "parameters", "parameters/Move", "parameters/Move/PointGun", "parameters/Move/WalkRun", "parameters/Moving", "parameters/Moving/PointGun", "parameters/Shooting", "parameters/Shooting/OneShot", "parameters/conditions", "tree_root" ]

[node name="Skeleton" parent="Rotation/Model/Root_Motion" index="2"]
transform = Transform( 0.18, 0, 0, 0, -7.86805e-09, -0.18, 0, 0.18, -7.86805e-09, 0, -0.0703342, 0 )
bones/9/bound_children = [ NodePath("Head") ]
bones/19/bound_children = [ NodePath("Left Hand") ]
bones/43/bound_children = [ NodePath("Right Hand") ]
_sections_unfolded = [ "Transform" ]

[node name="Model" parent="Rotation/Model/Root_Motion/Skeleton" index="0"]
material/0 = ExtResource( 2 )
_sections_unfolded = [ "material" ]

[node name="Right Hand" type="BoneAttachment" parent="Rotation/Model/Root_Motion/Skeleton" index="1"]
transform = Transform( -0.989679, -0.143287, 0.0014354, 0.00528549, -0.0465112, -0.998899, 0.143196, -0.988586, 0.0467894, -0.464057, 6.19833, -15.9437 )
bone_name = "enemy_r_finger1_01"

[node name="Left Hand" type="BoneAttachment" parent="Rotation/Model/Root_Motion/Skeleton" index="2"]
transform = Transform( -0.990603, 0.135327, -0.019733, 0.00319907, -0.121324, -0.992604, -0.136721, -0.983342, 0.119751, 0.331226, 5.55991, -15.5126 )
bone_name = "enemy_l_finger1_01"

[node name="Head" type="BoneAttachment" parent="Rotation/Model/Root_Motion/Skeleton" index="3"]
transform = Transform( -8.48294e-08, -1, -3.40626e-07, 0.995799, -5.32927e-08, -0.0915603, 0.0915603, -3.47636e-07, 0.995799, 8.97799e-07, -0.271965, -15.9156 )
bone_name = "enemy_head_jnt"
_sections_unfolded = [ "Transform" ]

[node name="Camera" type="Camera" parent="."]
transform = Transform( 1, 0, 0, 0, 1, 0, 0, 0, 1, 0, 2.42888, 2.89491 )
keep_aspect = 1
cull_mask = 1048575
environment = null
h_offset = 0.0
v_offset = 0.0
doppler_tracking = 0
projection = 0
current = false
fov = 70.0
size = 1.0
near = 0.05
far = 100.0


[editable path="Rotation/Model"]
